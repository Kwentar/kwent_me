services:
  # --- Reverse Proxy (Nginx) ---
  # В будущем можно упаковать Nginx тоже в Docker, но пока у тебя он на хосте.
  # Этот файл только для приложений.

  # --- Auth Proxy (Google Login) ---
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.5.1
    container_name: oauth2-proxy
    restart: always
    environment:
      OAUTH2_PROXY_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      OAUTH2_PROXY_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      OAUTH2_PROXY_COOKIE_SECRET: ${OAUTH2_PROXY_COOKIE_SECRET}
    volumes:
      - ./emails.txt:/emails.txt
    command: >
      --http-address=0.0.0.0:4180
      --provider=google
      --email-domain=*
      --authenticated-emails-file=/emails.txt
      --redirect-url=https://kwent.me/oauth2/callback
      --cookie-secure=true
      --cookie-domain=kwent.me
      --cookie-name=_oauth2_proxy
      --upstream=static://200
      --reverse-proxy=true
    ports:
      - "4180:4180"

  # --- Auth Test Service (/me) ---
  me:
    image: ghcr.io/IMAGE_NAME_PLACEHOLDER/me:latest
    container_name: kwent-me
    restart: always
    ports:
      - "4000:4000"

  # --- Notes App ---
  notes-db:
    image: postgres:17-alpine
    container_name: notes-db
    restart: always
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: kwent_notes
    volumes:
      - notes_postgres_data:/var/lib/postgresql/data

  notes-backend:
    image: ghcr.io/IMAGE_NAME_PLACEHOLDER/notes-backend:latest
    container_name: notes-backend
    restart: always
    environment:
      DATABASE_URL: postgres://user:${POSTGRES_PASSWORD}@notes-db:5432/kwent_notes
    depends_on:
      - notes-db
    ports:
      - "3000:3000"

volumes:
  notes_postgres_data: